import e from"../metadata.json"assert{type:"json"};import{valueInObj as n}from"node-utils";const t="0-9",r=["mobile","premiumRate","tollFree","sharedCost","voip","personalNumber","pager","uan","voicemail"],o=["premiumRate","tollFree","sharedCost","voip","personalNumber","pager","uan","voicemail","fixedLine","mobile"],i=e=>o.reduce(((n,t)=>{const r=e[t];if(!r)return n;const o=r?.nationalNumberPattern.replace(/\s/g,""),i=a(r.possibleLengths.national);return o&&(n[t]={pattern:o,possibleLengths:i}),n}),{}),a=e=>{const n=[];for(const t of e.split(",")){if(!t.trim())throw new Error;const e=t.match(/^\[(\d+)-(\d+)\]$/);if(e){const[,t,r]=e.map(Number);if(r-t<2)throw new Error;for(let e=t;e<=r;e++){if(n.includes(e))throw new Error;n.push(e)}}else{const e=Number(t);if(isNaN(e)||n.includes(e))throw new Error;n.push(e)}}return n},u=e=>{const n=i(e),t=[];for(const e of Object.keys(n)){const r=n[e]?.possibleLengths;for(const e of r)t.push(e);n[e].possibleLengths=r}return t.sort(((e,n)=>e-n))},s=(e,n,t)=>{const r=i(n),o=t?r[t]:void 0,a=o?.possibleLengths||u(n);if(t&&!o)return"INVALID_LENGTH";const s=e.length,c=a[0];return c===s?"IS_POSSIBLE":c>s?"TOO_SHORT":a[a.length-1]<s?"TOO_LONG":a.indexOf(s,1)>=0?"IS_POSSIBLE":"INVALID_LENGTH"},c=(e="",n)=>new RegExp("^(?:"+n+")$").test(e),l=({nationalNumber:e,countryMetadata:n})=>{const t=i(n),o=n.generalDesc.nationalNumberPattern;if(0!==Object.keys(t).length&&c(e,o)){if(f(e,t.fixedLine))return""===t.mobile.pattern?"fixedLineOrMobile":t.mobile?f(e,t.mobile)?"fixedLineOrMobile":"fixedLine":"fixedLineOrMobile";for(const n of r)if(f(e,t[n]))return n}},f=(e,n)=>{if(!n)return!1;const{pattern:t,possibleLengths:r}=n;return!!r.includes(e.length)&&c(e,t)},d=t=>!!n(t,e.countryCodes)||!!n(t,e.nonGeographic),m=({countryCode:t})=>{if(n(t,e.countryCodes)){const r=e.countryCodes[t][0];if(n(r,e.countries))return e.countries[r]}if(n(t,e.nonGeographic))return e.nonGeographic[t];throw new Error(`Unknown country code: ${t}`)},p=e=>void 0===e?[]:Array.isArray(e)?e:[e],h=e=>`([${t}]{1,${e}})`,g=new RegExp("(?:"+(()=>{const e="[ \t,]*",n="[:\\.]?[ \t,-]*",t="#?",r="[ \t]*";return";ext="+h("20")+"|"+(e+"(?:e?xt(?:ensi(?:o?))?n?|anexo)"+n+h("20")+t)+"|"+(e+"(?:[x#~]|int)"+n+h("9")+t)+"|"+("[- ]+"+h("6")+"#")+"|"+(r+"(?:,{2}|;)"+n+h("15")+t)+"|"+(r+"(?:,)+"+n+h("9")+t)})()+")$","i"),b="([0-9]|[\\-\\.\\(\\)]?)",N=new RegExp("^\\+"+b+"*["+t+"]"+b+"*$","g"),x=new RegExp("^([0-9]+((\\-)*[0-9])*\\.)*[a-zA-Z]+((\\-)*[0-9])*\\.?$","g"),y="tel:",O=";phone-context=",E=e=>{const n=(e=>{const n=e.indexOf(O);if(n<0)return null;const t=n+15;if(t>=e.length)return"";const r=e.indexOf(";",t);return r>=0?e.substring(t,r):e.substring(t)})(e);if(!(e=>null===e||0!==e.length&&(N.test(e)||x.test(e)))(n))throw new Error("NOT_A_NUMBER");let t;if(null===n){if(e.length>250)throw new Error("TOO_LONG");t=e}else{t="","+"===n.charAt(0)&&(t+=n);const r=e.indexOf(y);let o;o=r>=0?r+4:0;const i=e.indexOf(O);t+=e.substring(o,i)}const r=t.indexOf(";isub=");if(r>0&&(t=t.substring(0,r)),""!==t)return t},w=(e,n)=>{const t=((e,n)=>{const t=n.nationalPrefixForParsing||n.nationalPrefix,r=n.nationalPrefixTransformRule;if(t){const n=new RegExp("^(?:"+t+")"),o=n.exec(e);if(o){const t=o.length-1,i=t>0&&o[t];if(r&&i)return e.replace(n,r);{const n=o[0];return e.slice(n.length)}}}return e})(e,n);if(t!==e){if(!L({planMetadata:n,nationalNumberBefore:e,nationalNumberAfter:t}))return e;if(u(n)&&!I(t,n))return e}return t},L=e=>{const{nationalNumberBefore:n,nationalNumberAfter:t,planMetadata:r}=e,o=r.generalDesc.nationalNumberPattern;return!(c(n,o)&&!c(t,o))},I=(e,n)=>{switch(s(e,n)){case"TOO_SHORT":case"INVALID_LENGTH":return!1;default:return!0}},A=/(\$\d)/,$=(e,n,t)=>{const r=R(t.availableFormats,e);return r?((e,n,t,r,o)=>{const i=((e,n)=>{if(e&&n)return e.replace("$NP",n).replace("$FG","$1")})(n.nationalPrefixFormattingRule,o),a=e.replace(new RegExp(n.pattern),t?n.intlFormat||n.format:r&&i?n.format.replace(A,i):n.format);return t?a.replace(new RegExp("[-/.()~ ]+","g")," ").trim():a})(e,r,"INTERNATIONAL"===n,!!r.nationalPrefixOptionalWhenFormatting,t.nationalPrefix):e},C=(e,n,t)=>t?`${e}${n.preferredExtnPrefix??" ext. "}${t}`:e,T=({format:e,nationalNumber:n,countryCode:t,planMetadata:r,ext:o})=>{if("NATIONAL"===e){const e=$(n,"NATIONAL",r);return C(e,r,o)}if("INTERNATIONAL"===e){if(!n)return`+${t}`;const e=`+${t} ${$(n,"INTERNATIONAL",r)}`;return C(e,r,o)}if("E.164"===e)return`+${t}${n}`;if("RFC3966"===e)return(({number:e,ext:n})=>`tel:${e}${n?";ext="+n:""}`)({number:`+${t}${n}`,ext:o});throw new Error},R=(e,n)=>{const t=e?.numberFormat;if(t)for(const e of p(t)){const t=p(e.leadingDigits);if(t.length>0){const e=t[t.length-1];if(0!==n.search(e))continue}if(c(n,e.pattern))return e}},M=e=>{const n=E(e);if(!n)return{};if(!(e=>e.length>=2)(n))return{};const t=(e=>{const n=e.search(g);if(n<0)return;const t=e.slice(0,n),r=e.match(g);if(!r)return;let o=1;for(;o<r.length;){if(r[o])return{number:t,ext:r[o]};o++}})(n);return t||{number:n}},P=t=>{const{number:r,ext:o}=M(t);if(!r)throw new Error("Invalid phone number");const{countryCode:i,number:a}=(e=>{if("+"!==e[0])return{number:e};if("0"===e[1]||e.length<=3)return{};let n=2;for(;n-1<=3&&n<=e.length;){const t=e.slice(1,n);if(d(t))return{countryCode:t,number:e.slice(n)};n++}return{}})(F(r));if(!i||!a)throw new Error("Invalid phone number");const u=m({countryCode:i}),f=w(F(a),m({countryCode:i})),p=T({countryCode:i,nationalNumber:f,planMetadata:u,format:"NATIONAL"}),h=T({countryCode:i,nationalNumber:f,planMetadata:u,format:"INTERNATIONAL"}),g=T({countryCode:i,nationalNumber:f,planMetadata:u,format:"E.164"}),b=T({countryCode:i,nationalNumber:f,planMetadata:u,format:"RFC3966"}),{country:N,countryMetadata:x}=((t,r)=>{if(!n(t,e.countryCodes))return n(t,e.nonGeographic)?{countryMetadata:e.nonGeographic[t]}:{};const o=e.countryCodes[t];for(const t of o){if(!n(t,e.countries))continue;const o=e.countries[t];if(o)if("leadingDigits"in o){if(0===r.search(o.leadingDigits))return{country:t,countryMetadata:o}}else if(l({nationalNumber:r,countryMetadata:o}))return{country:t,countryMetadata:o}}return n(o[0],e.countries)?{countryMetadata:e.countries[o[0]],country:o[0]}:{country:o[0]}})(i,f);if(!f||f.length<2||f.length>17)throw new Error("Invalid phone number");const y=x?l({nationalNumber:f,countryMetadata:x}):void 0,O=!!x&&(void 0!==y||c(f,x.generalDesc.nationalNumberPattern));return{country:N,phone:a,countryCode:i,international:h,national:p,E164:g,RFC3966:b,possible:!!x&&"IS_POSSIBLE"===s(f,x),valid:O,type:y,ext:o}},v=e=>{const n=e.charCodeAt(0);return n>=48&&n<=57},F=e=>{let n="";if(!e)return n;for(const t of e.split(""))("+"===t&&!n||v(t))&&(n+=t);return n};export{P as parsePhoneNumber};
